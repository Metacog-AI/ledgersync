# --- LedgerSync Integration ---

# LedgerSync Integration

## CRITICAL: Shared Context Protocol

This project uses **LedgerSync** for shared context across AI coding agents. You MUST follow this protocol.

---

## On Session Start

1. **Read grounding docs** registered in `.ledgersync/config.yaml`:
   - Check the `philosophy.required` array
   - These docs define the product's DNA — read ALL of them before doing any work
   - Your decisions must align with these docs

2. **Read the ledger** to understand what other agents did:
   ```
   Check: .ledgersync/ledger.jsonl (last 20 entries)
   ```

3. **Check for relevant context** on files you'll touch — scan ledger for entries with those files in `artifacts`

---

## After Every Response

Append an entry to `.ledgersync/ledger.jsonl`. Format (single line, no pretty print):

```json
{"id":"[UUID-v4]","timestamp":"[ISO-8601]","agent":{"name":"cursor","model":"[model]"},"session":{"id":"[session-uuid]","entryIndex":[n]},"action":{"type":"[create|modify|delete|analyze|plan|debug|refactor|other]","summary":"[max 200 chars - WHAT you did]"},"reasoning":{"intent":"[WHY you did it]","considerations":["[trade-offs]"],"assumptions":["[assumptions]"],"uncertainties":["[unsure things]"]},"tools":[{"name":"[tool]"}],"artifacts":[{"path":"[file]","action":"[created|modified|deleted|read]"}],"grounding":{"philosophyRefs":["[grounding docs you consulted]"],"alignmentNotes":"[how this aligns with product philosophy]"}}
```

### Minimal Example
```json
{"id":"a1b2c3d4-5678-90ab-cdef-1234567890ab","timestamp":"2026-01-16T02:15:00Z","agent":{"name":"cursor"},"session":{"id":"sess-001","entryIndex":0},"action":{"type":"modify","summary":"Fixed auth bug in middleware"},"reasoning":{"intent":"User reported login failures"},"tools":[],"artifacts":[{"path":"src/auth.ts","action":"modified"}],"grounding":{"philosophyRefs":["./docs/philosophy.md"],"alignmentNotes":"Security fix aligns with security-first principle"}}
```

---

## Conflict Detection

Before modifying any file:

1. Scan ledger for recent entries touching that file
2. If another agent modified it recently:
   - Read their `reasoning.intent`
   - If your change conflicts, WARN the user:
     > "[Agent] modified `src/auth.ts` 2 hours ago to [their intent]. My change might conflict. Proceed?"
3. If you proceed despite conflict, document it in your entry

---

## Key Rules

| Rule | Description |
|------|-------------|
| **Append-only** | Never modify or delete past ledger entries |
| **Capture WHY** | `reasoning.intent` is more valuable than `action.summary` |
| **Ground decisions** | Read grounding docs, reference them in `grounding` field |
| **Agents can disagree** | You CAN override another agent, but document why |

---

## Quick Reference: Entry Fields

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | UUID v4 |
| `timestamp` | Yes | ISO 8601 with timezone |
| `agent.name` | Yes | Your agent name (e.g. "cursor") |
| `session.id` | Yes | UUID for your session |
| `session.entryIndex` | Yes | 0, 1, 2... per session |
| `entryType` | No | handoff/transition/implementation/bugfix/review |
| `action.type` | Yes | create/modify/delete/analyze/plan/debug/refactor/other |
| `action.summary` | Yes | One-line summary (max 200 chars) |
| `reasoning.intent` | Yes | Why you did this |
| `tools` | Yes | Array of tools called |
| `artifacts` | Yes | Array of files touched |
| `reasoning.considerations` | No | Trade-offs considered |
| `reasoning.uncertainties` | No | Things you're unsure about |
| `reasoning.confidence` | No | 0.0-1.0 confidence score |
| `grounding.philosophyRefs` | No | Grounding docs that influenced you |
| `grounding.alignmentNotes` | No | How this aligns with product philosophy |

---

## Entry Types

Use `entryType` for semantic structure:

| Type | When | Who |
|------|------|-----|
| `handoff` | Ending session, preparing for next agent | Outgoing agent |
| `transition` | Starting session, confirming context receipt | Incoming agent |
| `implementation` | Building new features | Any |
| `bugfix` | Fixing specific issue | Any |
| `review` | Code audit without changes | Any |

### Handoff/Transition Pattern

When switching agents:
1. **Outgoing agent** writes `entryType: "handoff"` with `sessionSummary`
2. **Incoming agent** writes `entryType: "transition"` with `transition`

### Handoff Example (When You End)
```json
{"entryType":"handoff","sessionSummary":{"completed":["done items"],"currentState":{"component":"state"},"deferred":["todo items"],"blockers":[],"importantContext":{"key":"critical info"},"handoffNotes":"Free-form notes"}}
```

### Transition Example (When You Start)
```json
{"entryType":"transition","transition":{"fromAgent":"[prior-agent]","fromSessionId":"[id]","fromEntryId":"[id]","contextAcquired":{"entriesRead":4,"philosophyDocsRead":[],"filesIndexed":[]},"inheritedState":{"completed":[],"deferred":[],"blockers":[]},"readiness":{"confident":true,"clarificationsNeeded":[],"proposedNextSteps":[]}}}
```
